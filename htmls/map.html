<!DOCTYPE html>
<style>
    .tooltip {
      position: absolute;
      padding: 7px;
      font-size: 0.9em;
      pointer-events: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;

      /* 添加阴影效果 */
      -moz-box-shadow:    3px 3px 10px 0px rgba(0, 0, 0, 0.25);
      -webkit-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
      box-shadow:         3px 3px 10px 0px rgba(0, 0, 0, 0.25);
    }
    .tooltip p {
      margin: 0;
      padding: 0;
    }
    .tooltip table {
      margin: 0;
      padding: 0;
      border-collapse: collapse;
    }
</style>

<html>

<head>
    <title>Map</title>
    <script src="d3.js"></script>
</head>

<body>
    <svg width="1600", height="1600" id="mainsvg" class="svgs" style='display: block; margin: 0 auto;'></svg>
    <script>
        // tool tip initialize
        console.log("Hello world!")
        let tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // initialize svg
        const svg = d3.select('svg');
        const width = svg.attr('width');
        const height = svg.attr('height');
        const margin = { top: 100, right: 100, bottom: 100, left: 100 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        // initialize building group
        const buildingGroup = svg.append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`)
            .attr('id', 'buildingGroup');

        // initialize label group
        const labelGroup = svg.append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`)
            .attr('id', 'labelGroup');

        // initialize scale
        const xScale = d3.scaleLinear();
        const yScale = d3.scaleLinear();
        const colorScale = d3.scaleOrdinal();

        d3.json('./data/Attributes/Buildings.json').then(async data => {
            var features = data.features;
            var coor_data = [];

            // set x y axis
            xScale.domain([d3.min(features, d => d3.min(d.geometry.coordinates, d => +d[0])) - 100, d3.max(features, d => d3.max(d.geometry.coordinates, d => +d[0])) + 100])
                .range([0, innerWidth]);
            yScale.domain([d3.min(features, d => d3.min(d.geometry.coordinates, d => +d[1])) - 100, d3.max(features, d => d3.max(d.geometry.coordinates, d => +d[1])) + 100])
                .range([innerHeight, 0]);

            // set color scale
            colorScale.domain(features.map(d => d.properties.buildingType)).range(d3.schemeCategory10);

            // draw map
            var line = d3.line();
            buildingGroup.selectAll('path').data(features).join('path')
                .attr('class', name)
                .attr('fill', d => colorScale(d.properties.buildingType))
                .attr('d', function(d) {
                    var coor_data = [];
                    d.geometry.coordinates.forEach(function(d) {
                        coor_data.push([xScale(+d[0]), yScale(+d[1])]);
                    });

                    return line(coor_data);
                })
                .attr('stroke', 'black')
                .attr('stroke-width', '1px')
                .attr('opacity', 0.6)
                .on("mouseover", function(event, d) {
                    d3.select(this).transition().duration(100).attr("fill", "lightblue");
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    // show buildingId, buildingType, maxOccupancy
                    tooltip.html("<p>BuildingId: " + d.properties.buildingId + "</p>" +
                        "<p>BuildingType: " + d.properties.buildingType + "</p>" +
                        "<p>MaxOccupancy: " + d.properties.maxOccupancy + "</p>")
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).transition().duration(100).attr("fill", colorScale(d.properties.buildingType));
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // draw label from color scale
            labelGroup.selectAll('rect').data(colorScale.domain()).join('rect')
                .attr('x', (d, i) => xScale(d3.max(xScale.domain()) - 50))
                .attr('y', (d, i) => yScale(d3.min(yScale.domain()) + i * 100))
                .attr('width', 10)
                .attr('height', 10)
                .attr('fill', d => colorScale(d));

            labelGroup.selectAll('text').data(colorScale.domain()).join('text')
                .attr('x', (d, i) => xScale(d3.max(xScale.domain()) - 50) + 15)
                .attr('y', (d, i) => yScale(d3.min(yScale.domain()) + i * 100) + 10)
                .text(d => d);
        }
        );
    </script>
</body>
</html>